---

title: nbdev callbacks

keywords: fastai
sidebar: home_sidebar

summary: "The build docs and test nbs functions are extensible, with callbacks."
description: "The build docs and test nbs functions are extensible, with callbacks."
nb_path: "nbs/09_nbdev_callback_test.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/09_nbdev_callback_test.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The goal of nbdev callbacks: Make it possible for you to customise the testing and build doc processes to suit the needs of your projects, without needing changes to nbdev.</p>
<p>If you'd like to use callbacks, create <code>nbdev_callbacks.py</code> in your project. Feel free to copy <a href="https://github.com/fastai/nbdev/blob/master/nbdev_callbacks.py">nbdev_callbacks.py</a> to get started.</p>
<p>Before we get stuck into how you can use callbacks, we need to explain how <em>your</em> <code>nbdev_callbacks.py</code> gets imported.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="call_cb" class="doc_header"><code>call_cb</code><a href="https://github.com/fastai/nbdev/tree/master/nbdev/imports.py#L76" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>call_cb</code>(<strong><code>cb_name</code></strong>, <strong>*<code>args</code></strong>)</p>
</blockquote>
<p>Calls <code>cb_name</code> from the <code>nbdev_callbacks</code> module but won't fail if it doesn't exist</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>After making a temporary modification to <code>sys.path</code>, this function loads the <code>nbdev_callbacks</code> module via a regular python <code>import</code>.</p>
<p>To be sure this import reads the <code>nbdev_callbacks.py</code> file from your project, <code>call_cb</code> will make the parameter <code>callbacks_path</code> (see <code>settings.ini</code>) the only entry in <code>sys.path</code> (defaulting to the project root).</p>
<p><code>nbdev_callbacks.py</code> does not have to exist and doesn't have to contain definitions for all callback handlers.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">call_cb</span><span class="p">(</span><span class="s1">&#39;begin_test_nb&#39;</span><span class="p">,</span> <span class="s1">&#39;arg1&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;arg1&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">call_cb</span><span class="p">(</span><span class="s1">&#39;after_test_nb&#39;</span><span class="p">,</span> <span class="s1">&#39;file.name&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
<span class="c1"># If we pass an invalid callback name, we get the 1st arg back ...</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">call_cb</span><span class="p">(</span><span class="s1">&#39;bad_cb_name&#39;</span><span class="p">,</span> <span class="s1">&#39;arg1&#39;</span><span class="p">),</span> <span class="s1">&#39;arg1&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">call_cb</span><span class="p">(</span><span class="s1">&#39;bad_cb_name&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">call_cb</span><span class="p">(</span><span class="s1">&#39;bad_cb_name&#39;</span><span class="p">,</span> <span class="s1">&#39;arg1&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;arg1&#39;</span><span class="p">)</span>
<span class="c1"># ... or None if we pass no args. Either way we see no errors</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">call_cb</span><span class="p">(</span><span class="s1">&#39;bad_cb_name&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">call_cb</span><span class="p">(</span><span class="s1">&#39;begin_test_nb&#39;</span><span class="p">,</span> <span class="s1">&#39;arg1&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;An error should be raised as we passed the wrong number of arguments to the cb&#39;</span>
<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">nbdev_callbacks</span>
<span class="n">nbdev_callbacks</span><span class="o">.</span><span class="n">raise_err</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">call_cb</span><span class="p">(</span><span class="s1">&#39;raise_err&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;An error should be raised because the cb handler raised an error&#39;</span>
<span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span> <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you ever need to import the <code>nbdev_callbacks</code> in your code, please make a call to <code>call_cb</code> first.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">call_cb</span><span class="p">(</span><span class="s1">&#39;This makes sure nbdev_callbacks is loaded from the right place&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">nbdev_callbacks</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="nbdev_callbacks.begin_test_nb" class="doc_header"><code>nbdev_callbacks.begin_test_nb</code><a href="nbdev_callbacks.py#L3" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>nbdev_callbacks.begin_test_nb</code>(<strong><code>nb</code></strong>, <strong><code>file_name</code></strong>, <strong><code>flags</code></strong>)</p>
</blockquote>
<p>Called before testing a notebook. Return the notebook to be tested</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It is expected that you'll want to modify and return <code>nb</code> but your callback handler <em>could</em> create and return a new notebook.</p>
<p><code>file_name</code> can't be modified as it has already been used to create <code>nb</code>.</p>
<p><a href="/test#test_nb"><code>test_nb</code></a> calls <code>begin_test_nb</code> before checking flags so you <em>could</em> use callbacks to modify flags before testing starts.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="nbdev_callbacks.after_test_nb" class="doc_header"><code>nbdev_callbacks.after_test_nb</code><a href="nbdev_callbacks.py#L7" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>nbdev_callbacks.after_test_nb</code>(<strong><code>file_name</code></strong>)</p>
</blockquote>
<p>Called after testing a notebook</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="nbdev_callbacks.begin_doc_nb" class="doc_header"><code>nbdev_callbacks.begin_doc_nb</code><a href="nbdev_callbacks.py#L11" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>nbdev_callbacks.begin_doc_nb</code>(<strong><code>nb</code></strong>, <strong><code>file_name</code></strong>, <strong><code>output_type</code></strong>)</p>
</blockquote>
<p>Called before converting a notebook to documentation. Return the notebook to be converted</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It is expected that you'll want to modify and return <code>nb</code> but your callback handler <em>could</em> create and return a new notebook.</p>
<p><code>file_name</code> can't be modified as it has already been used to create <code>nb</code>.</p>
<ul>
<li>When building HTML docs, <a href="/export2html#convert_nb"><code>convert_nb</code></a> will set <code>output_type='html'</code></li>
<li>When building markdown docs, <a href="/export2html#convert_md"><code>convert_md</code></a> will set <code>output_type='md'</code></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="nbdev_callbacks.after_doc_nb_preprocess" class="doc_header"><code>nbdev_callbacks.after_doc_nb_preprocess</code><a href="nbdev_callbacks.py#L15" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>nbdev_callbacks.after_doc_nb_preprocess</code>(<strong><code>nb</code></strong>, <strong><code>file_name</code></strong>, <strong><code>output_type</code></strong>)</p>
</blockquote>
<p>Called after pre-processing a notebook, before converting to documentation. Return the notebook to be converted</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This callback handler gets the same arguments as <code>begin_doc_nb</code> but <code>nb</code> will have been modifed by processors that do things like:</p>
<ul>
<li>add <a href="/showdoc#show_doc"><code>show_doc</code></a> calls for for exported functions and classes</li>
<li>remove empty cells</li>
<li>copy images and modify image paths</li>
<li>add collapse metadata etc</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="nbdev_callbacks.after_doc_nb" class="doc_header"><code>nbdev_callbacks.after_doc_nb</code><a href="nbdev_callbacks.py#L19" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>nbdev_callbacks.after_doc_nb</code>(<strong><code>file_name</code></strong>, <strong><code>output_type</code></strong>)</p>
</blockquote>
<p>Called after converting a notebook to documentation</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="What-kind-of-things-can-you-do-with-these-callbacks?">What kind of things can you do with these callbacks?<a class="anchor-link" href="#What-kind-of-things-can-you-do-with-these-callbacks?"> </a></h1><h2 id="Move-img-tags-to-the-start-of-a-new-line">Move img tags to the start of a new line<a class="anchor-link" href="#Move-img-tags-to-the-start-of-a-new-line"> </a></h2><p>To display images side-by-side we could use some HTML like:</p>

<pre><code>&lt;figure&gt;
    &lt;div style="display:flex"&gt;
        &lt;div style="flex:1"&gt;
            &lt;figure&gt;
                &lt;img src="images/post_004/02.jpeg"&gt;
                &lt;figcaption&gt;&lt;center&gt;Temp caption 1&lt;/center&gt;&lt;/figcaption&gt;
            &lt;/figure&gt;
        &lt;/div&gt;
        &lt;div style="flex:1"&gt;
            &lt;figure&gt;
                &lt;img src="images/post_004/03.jpeg"&gt;
                &lt;figcaption&gt;&lt;center&gt;Temp caption 2&lt;/center&gt;&lt;/figcaption&gt;
            &lt;/figure&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;figcaption&gt;&lt;center&gt;Main caption&lt;/center&gt;&lt;/figcaption&gt;
&lt;/figure&gt;</code></pre>
<p>Then you find that nbdev will only copy images and modify image paths for zero indented img tags.</p>
<p>You could modify your HTML ... or you could move image tags with a callback:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">begin_doc_nb</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="n">file_name</span><span class="p">,</span><span class="n">output_type</span><span class="p">):</span>
    <span class="s2">&quot;Called before converting a notebook to documentation. Return the notebook to be converted&quot;</span>
    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">nb</span><span class="p">[</span><span class="s1">&#39;cells&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;markdown&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;`&#39;</span><span class="p">):</span>
            <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;img &quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;img &quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nb</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Count-the-number-of-tests-cells">Count the number of tests cells<a class="anchor-link" href="#Count-the-number-of-tests-cells"> </a></h2><p>To output the number of tests that have been run, you could count each cell that is not exported to your library:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.export</span> <span class="kn">import</span> <span class="n">find_default_export</span><span class="p">,</span><span class="n">is_export</span>

<span class="k">def</span> <span class="nf">begin_test_nb</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="n">file_name</span><span class="p">,</span><span class="n">flags</span><span class="p">):</span>
    <span class="n">test_count</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">default_export</span><span class="o">=</span><span class="n">find_default_export</span><span class="p">(</span><span class="n">nb</span><span class="p">[</span><span class="s1">&#39;cells&#39;</span><span class="p">])</span>
    <span class="n">exports</span><span class="o">=</span><span class="p">[</span><span class="n">is_export</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">default_export</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">nb</span><span class="p">[</span><span class="s1">&#39;cells&#39;</span><span class="p">]]</span>
    <span class="n">cells</span><span class="o">=</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">c</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nb</span><span class="p">[</span><span class="s1">&#39;cells&#39;</span><span class="p">],</span><span class="n">exports</span><span class="p">))</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="p">:</span> <span class="n">test_count</span><span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="s1">&#39;has&#39;</span><span class="p">,</span><span class="n">test_count</span><span class="p">,</span><span class="s1">&#39;test cells&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nb</span>
</pre></div>
<p>The above is just one interpretation of "the number of tests". We could easily write callback handlers to count tests in different ways, like:</p>
<ul>
<li>the number of <code>assert</code> or <code>test_eq</code> calls in the notebook</li>
<li>the number of cells that contain an <code>assert</code> or <code>test_eq</code> call</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Reserved-callback-handler-names">Reserved callback handler names<a class="anchor-link" href="#Reserved-callback-handler-names"> </a></h1><table>
<thead><tr>
<th>Callback handler</th>
<th></th>
<th>Call from</th>
<th>Comments</th>
</tr>
</thead>
<tbody>
<tr>
<td>begin_test_nbs</td>
<td>after_test_nbs</td>
<td>cli#nbdev_test_nbs</td>
<td>Might be useful if writing test metrics to log files etc</td>
</tr>
<tr>
<td>begin_doc_nbs</td>
<td>after_doc_nbs</td>
<td>cli#nbdev_build_docs</td>
<td></td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
 

